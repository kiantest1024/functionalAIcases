{% extends "ai_base.html" %}

{% block title %}AIæ™ºèƒ½ç”Ÿæˆ - åŠŸèƒ½æµ‹è¯•ç”¨ä¾‹ç”Ÿæˆå™¨{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <h4 class="mb-0">
                    <i class="bi bi-robot"></i> AIæ™ºèƒ½ç”ŸæˆåŠŸèƒ½æµ‹è¯•ç”¨ä¾‹
                </h4>
            </div>
            <div class="card-body">
                <div class="alert alert-info" role="alert">
                    <h6 class="alert-heading"><i class="bi bi-lightbulb"></i> AIå¢å¼ºç‰¹æ€§</h6>
                    <p class="mb-0">
                        AIå°†è‡ªåŠ¨åˆ†ææ‚¨çš„éœ€æ±‚æ–‡æ¡£ï¼Œè¯†åˆ«å¤æ‚åº¦ã€é£é™©åŒºåŸŸå’Œå…³é”®è·¯å¾„ï¼Œ
                        ç„¶åç»“åˆ8ç§æµ‹è¯•æ–¹æ³•ç”Ÿæˆæ›´æ™ºèƒ½ã€æ›´å…¨é¢çš„æµ‹è¯•ç”¨ä¾‹ã€‚
                    </p>
                </div>
                
                <form method="POST" action="{{ url_for('ai_generate') }}">
                    <!-- éœ€æ±‚æ–‡æ¡£è¾“å…¥ -->
                    <div class="mb-4">
                        <label for="requirement_text" class="form-label">
                            <i class="bi bi-file-text"></i> éœ€æ±‚æ–‡æ¡£å†…å®¹ <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" id="requirement_text" name="requirement_text" 
                                rows="12" required placeholder="è¯·è¾“å…¥éœ€æ±‚æ–‡æ¡£å†…å®¹ï¼ŒAIå°†è‡ªåŠ¨åˆ†æä»¥ä¸‹ä¿¡æ¯ï¼š

ğŸ“‹ åŠŸèƒ½æè¿°å’Œæ¨¡å—åˆ’åˆ†
ğŸ” ä¸šåŠ¡è§„åˆ™å’Œçº¦æŸæ¡ä»¶  
ğŸ“Š è¾“å…¥å­—æ®µå’Œæ•°æ®ç±»å‹
ğŸ”„ çŠ¶æ€è½¬æ¢å’Œå·¥ä½œæµç¨‹
ğŸ”— é›†æˆç‚¹å’Œå¤–éƒ¨ä¾èµ–
âš ï¸ æ½œåœ¨é£é™©å’Œå®‰å…¨è€ƒè™‘
ğŸ¯ æ€§èƒ½è¦æ±‚å’Œå¯ç”¨æ€§éœ€æ±‚

ç¤ºä¾‹ï¼š
ç”µå•†è®¢å•ç®¡ç†ç³»ç»Ÿ

åŠŸèƒ½ï¼šè®¢å•å¤„ç†å’Œç®¡ç†
æ¨¡å—ï¼šè®¢å•ç³»ç»Ÿã€æ”¯ä»˜ç³»ç»Ÿã€åº“å­˜ç³»ç»Ÿ

è¾“å…¥å­—æ®µï¼š
- å•†å“IDï¼šæ•°å­—ç±»å‹ï¼Œå¿…å¡«ï¼ŒèŒƒå›´1-999999
- å•†å“æ•°é‡ï¼šæ•´æ•°ï¼Œå¿…å¡«ï¼ŒèŒƒå›´1-99
- ç”¨æˆ·IDï¼šå­—ç¬¦ä¸²ï¼Œå¿…å¡«ï¼Œé•¿åº¦8-20
- æ”¶è´§åœ°å€ï¼šæ–‡æœ¬ï¼Œå¿…å¡«ï¼Œæœ€å¤§500å­—ç¬¦
- æ”¯ä»˜æ–¹å¼ï¼šæšä¸¾ï¼Œå¿…å¡«ï¼ˆæ”¯ä»˜å®/å¾®ä¿¡/é“¶è¡Œå¡ï¼‰

ä¸šåŠ¡è§„åˆ™ï¼š
1. ä¸‹å•æ—¶éœ€è¦éªŒè¯åº“å­˜å……è¶³
2. æ”¯ä»˜æˆåŠŸåè‡ªåŠ¨å‡å°‘åº“å­˜
3. è®¢å•è¶…è¿‡30åˆ†é’Ÿæœªæ”¯ä»˜è‡ªåŠ¨å–æ¶ˆ
4. VIPç”¨æˆ·äº«å—ä¼˜å…ˆå¤„ç†

çŠ¶æ€è½¬æ¢ï¼š
å¾…æ”¯ä»˜ -> å·²æ”¯ä»˜ -> å·²å‘è´§ -> å·²æ”¶è´§ -> å·²å®Œæˆ
å¾…æ”¯ä»˜ -> å·²å–æ¶ˆ

é›†æˆç‚¹ï¼š
- ç¬¬ä¸‰æ–¹æ”¯ä»˜æ¥å£
- ç‰©æµæŸ¥è¯¢æ¥å£  
- åº“å­˜ç®¡ç†ç³»ç»Ÿ
- ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ

æ€§èƒ½è¦æ±‚ï¼š
- è®¢å•åˆ›å»ºå“åº”æ—¶é—´ < 2ç§’
- æ”¯æŒ1000å¹¶å‘ç”¨æˆ·
- 99.9%å¯ç”¨æ€§

å®‰å…¨è¦æ±‚ï¼š
- æ”¯ä»˜ä¿¡æ¯åŠ å¯†ä¼ è¾“
- ç”¨æˆ·æƒé™éªŒè¯
- é˜²æ­¢é‡å¤æäº¤"></textarea>
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i> 
                            AIå°†åˆ†ææ–‡æ¡£ä¸­çš„ä¸šåŠ¡è§„åˆ™ã€æ•°æ®æ¨¡å¼ã€é£é™©åŒºåŸŸç­‰ä¿¡æ¯ï¼Œç”Ÿæˆé’ˆå¯¹æ€§çš„æµ‹è¯•ç”¨ä¾‹
                        </div>
                    </div>

                    <!-- AIå¢å¼ºçº§åˆ« -->
                    <div class="mb-4">
                        <label class="form-label">
                            <i class="bi bi-cpu"></i> AIå¢å¼ºçº§åˆ«
                        </label>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card ai-level-card" data-level="basic">
                                    <div class="card-body text-center">
                                        <input type="radio" name="ai_enhancement_level" value="basic" id="level_basic" class="form-check-input">
                                        <label for="level_basic" class="form-check-label w-100">
                                            <h6 class="mt-2">åŸºç¡€AIå¢å¼º</h6>
                                            <p class="small text-muted">æ ‡å‡†æµ‹è¯•æ–¹æ³• + åŸºç¡€AIåˆ†æ</p>
                                            <div class="badge bg-success">å¿«é€Ÿ</div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card ai-level-card" data-level="medium">
                                    <div class="card-body text-center">
                                        <input type="radio" name="ai_enhancement_level" value="medium" id="level_medium" class="form-check-input" checked>
                                        <label for="level_medium" class="form-check-label w-100">
                                            <h6 class="mt-2">æ ‡å‡†AIå¢å¼º</h6>
                                            <p class="small text-muted">å…¨é¢AIåˆ†æ + æ™ºèƒ½ä¼˜åŒ–</p>
                                            <div class="badge bg-primary">æ¨è</div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card ai-level-card" data-level="advanced">
                                    <div class="card-body text-center">
                                        <input type="radio" name="ai_enhancement_level" value="advanced" id="level_advanced" class="form-check-input">
                                        <label for="level_advanced" class="form-check-label w-100">
                                            <h6 class="mt-2">é«˜çº§AIå¢å¼º</h6>
                                            <p class="small text-muted">æ·±åº¦åˆ†æ + é¢„æµ‹æ€§æµ‹è¯•</p>
                                            <div class="badge bg-warning">å…¨é¢</div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å†å²ç¼ºé™·è¾“å…¥ -->
                    <div class="mb-4">
                        <label for="historical_defects" class="form-label">
                            <i class="bi bi-bug"></i> å†å²ç¼ºé™·åˆ—è¡¨ <span class="text-muted">(å¯é€‰ï¼ŒAIå°†è¿›è¡Œç¼ºé™·æ¨¡å¼åˆ†æ)</span>
                        </label>
                        <textarea class="form-control" id="historical_defects" name="historical_defects" 
                                rows="6" placeholder="æ¯è¡Œè¾“å…¥ä¸€ä¸ªå†å²ç¼ºé™·ï¼ŒAIå°†åˆ†æç¼ºé™·æ¨¡å¼å¹¶ç”Ÿæˆé¢„æµ‹æ€§æµ‹è¯•ç”¨ä¾‹ï¼š

è®¢å•æ”¯ä»˜æ—¶å‡ºç°SQLæ³¨å…¥æ¼æ´
é«˜å¹¶å‘ä¸‹åº“å­˜æ•°æ®ä¸ä¸€è‡´
ç”¨æˆ·æƒé™éªŒè¯å¯ä»¥è¢«ç»•è¿‡
æ”¯ä»˜æ¥å£è¶…æ—¶æœªæ­£ç¡®å¤„ç†
è®¢å•çŠ¶æ€æ›´æ–°æ—¶å‡ºç°æ­»é”
XSSæ”»å‡»å¯¼è‡´ç”¨æˆ·ä¿¡æ¯æ³„éœ²
ç¼“å­˜æ•°æ®æœªåŠæ—¶æ›´æ–°å¯¼è‡´æ˜¾ç¤ºé”™è¯¯
æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½å­˜åœ¨å®‰å…¨æ¼æ´"></textarea>
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i> 
                            AIå°†åˆ†æå†å²ç¼ºé™·æ¨¡å¼ï¼Œç”Ÿæˆæ™ºèƒ½å›å½’æµ‹è¯•å’Œé¢„æµ‹æ€§é”™è¯¯æµ‹è¯•ç”¨ä¾‹
                        </div>
                    </div>

                    <!-- è‡ªå®šä¹‰å­—æ®µæ ‡é¢˜ -->
                    <div class="mb-4">
                        <label for="custom_headers" class="form-label">
                            <i class="bi bi-gear"></i> è‡ªå®šä¹‰å­—æ®µæ ‡é¢˜ <span class="text-muted">(å¯é€‰)</span>
                        </label>
                        <textarea class="form-control" id="custom_headers" name="custom_headers" 
                                rows="4" placeholder='JSONæ ¼å¼ï¼Œè‡ªå®šä¹‰è¾“å‡ºè¡¨æ ¼çš„å­—æ®µæ ‡é¢˜ï¼š

{
    "Module": "åŠŸèƒ½æ¨¡å—",
    "CaseID": "æµ‹è¯•ç¼–å·", 
    "TestSteps": "æ“ä½œæ­¥éª¤",
    "Expected": "æœŸæœ›ç»“æœ",
    "Priority": "é‡è¦ç¨‹åº¦",
    "Remark": "AIåˆ†æå¤‡æ³¨"
}'></textarea>
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i> 
                            ä½¿ç”¨JSONæ ¼å¼è‡ªå®šä¹‰è¾“å‡ºè¡¨æ ¼çš„å­—æ®µæ ‡é¢˜
                        </div>
                    </div>

                    <!-- å®æ—¶AIåˆ†æé¢„è§ˆ -->
                    <div class="mb-4">
                        <div class="card bg-light">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-eye"></i> å®æ—¶AIåˆ†æé¢„è§ˆ
                                    <button type="button" class="btn btn-sm btn-outline-primary float-end" id="analyzeBtn">
                                        <i class="bi bi-search"></i> åˆ†æéœ€æ±‚
                                    </button>
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="aiAnalysisPreview">
                                    <p class="text-muted">è¾“å…¥éœ€æ±‚æ–‡æ¡£åï¼Œç‚¹å‡»"åˆ†æéœ€æ±‚"æŸ¥çœ‹AIåˆ†æç»“æœ</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æäº¤æŒ‰é’® -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary me-md-2">
                            <i class="bi bi-arrow-left"></i> è¿”å›é¦–é¡µ
                        </a>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-robot"></i> AIæ™ºèƒ½ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- AIå¢å¼ºè¯´æ˜ -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card bg-light">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle"></i> AIå¢å¼ºè¯´æ˜
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="bi bi-brain text-primary"></i> AIåˆ†æèƒ½åŠ›ï¼š</h6>
                        <ul class="list-unstyled">
                            <li><i class="bi bi-check text-success"></i> è‡ªåŠ¨è®¡ç®—éœ€æ±‚å¤æ‚åº¦è¯„åˆ†</li>
                            <li><i class="bi bi-check text-success"></i> æ™ºèƒ½è¯†åˆ«å®‰å…¨å’Œæ€§èƒ½é£é™©</li>
                            <li><i class="bi bi-check text-success"></i> æå–å…³é”®ä¸šåŠ¡è·¯å¾„</li>
                            <li><i class="bi bi-check text-success"></i> åˆ†ææ•°æ®æ¨¡å¼å’Œçº¦æŸ</li>
                            <li><i class="bi bi-check text-success"></i> è¯†åˆ«é›†æˆç‚¹å’Œä¾èµ–å…³ç³»</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="bi bi-gear-wide-connected text-success"></i> AIå¢å¼ºæµ‹è¯•ï¼š</h6>
                        <ul class="list-unstyled">
                            <li><i class="bi bi-check text-success"></i> åŸºäºå¤æ‚åº¦çš„è‡ªé€‚åº”è¾¹ç•Œå€¼æµ‹è¯•</li>
                            <li><i class="bi bi-check text-success"></i> è¯­ä¹‰é©±åŠ¨çš„ç­‰ä»·ç±»åˆ’åˆ†</li>
                            <li><i class="bi bi-check text-success"></i> ä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„åœºæ™¯æµ‹è¯•</li>
                            <li><i class="bi bi-check text-success"></i> é¢„æµ‹æ€§é”™è¯¯åˆ†æ</li>
                            <li><i class="bi bi-check text-success"></i> æ™ºèƒ½ä¼˜å…ˆçº§è°ƒæ•´å’Œè¦†ç›–åº¦ä¼˜åŒ–</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// AIçº§åˆ«é€‰æ‹©æ•ˆæœ
document.addEventListener('DOMContentLoaded', function() {
    const levelCards = document.querySelectorAll('.ai-level-card');
    const radios = document.querySelectorAll('input[name="ai_enhancement_level"]');
    
    // åˆå§‹åŒ–é€‰ä¸­çŠ¶æ€
    updateLevelCardStyles();
    
    levelCards.forEach(card => {
        card.addEventListener('click', function() {
            const level = this.dataset.level;
            const radio = document.getElementById(`level_${level}`);
            radio.checked = true;
            updateLevelCardStyles();
        });
    });
    
    radios.forEach(radio => {
        radio.addEventListener('change', updateLevelCardStyles);
    });
    
    function updateLevelCardStyles() {
        levelCards.forEach(card => {
            const level = card.dataset.level;
            const radio = document.getElementById(`level_${level}`);
            
            if (radio.checked) {
                card.classList.add('border-primary', 'bg-primary', 'text-white');
                card.classList.remove('border-light');
            } else {
                card.classList.remove('border-primary', 'bg-primary', 'text-white');
                card.classList.add('border-light');
            }
        });
    }
});

// å®æ—¶AIåˆ†æ
document.getElementById('analyzeBtn').addEventListener('click', function() {
    const requirementText = document.getElementById('requirement_text').value.trim();
    
    if (!requirementText) {
        alert('è¯·å…ˆè¾“å…¥éœ€æ±‚æ–‡æ¡£å†…å®¹');
        return;
    }
    
    const btn = this;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> åˆ†æä¸­...';
    btn.disabled = true;
    
    fetch('/ai_analysis', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            requirement_text: requirementText
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayAnalysisResult(data.analysis, data.recommendations);
        } else {
            document.getElementById('aiAnalysisPreview').innerHTML = 
                `<div class="alert alert-danger">åˆ†æå¤±è´¥: ${data.error}</div>`;
        }
    })
    .catch(error => {
        document.getElementById('aiAnalysisPreview').innerHTML = 
            `<div class="alert alert-danger">åˆ†æå‡ºé”™: ${error.message}</div>`;
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
});

function displayAnalysisResult(analysis, recommendations) {
    const preview = document.getElementById('aiAnalysisPreview');
    
    let html = `
        <div class="row">
            <div class="col-md-6">
                <h6><i class="bi bi-speedometer2 text-primary"></i> å¤æ‚åº¦åˆ†æ</h6>
                <div class="progress mb-2">
                    <div class="progress-bar bg-${getComplexityColor(analysis.complexity_score)}" 
                         style="width: ${analysis.complexity_score * 100}%"></div>
                </div>
                <small>å¤æ‚åº¦è¯„åˆ†: ${analysis.complexity_score.toFixed(2)} (${analysis.complexity_level})</small>
                
                ${analysis.risk_areas.length > 0 ? `
                <h6 class="mt-3"><i class="bi bi-exclamation-triangle text-warning"></i> é£é™©åŒºåŸŸ</h6>
                <ul class="list-unstyled">
                    ${analysis.risk_areas.slice(0, 3).map(risk => `<li><span class="badge bg-warning me-1">âš ï¸</span>${risk}</li>`).join('')}
                </ul>
                ` : ''}
            </div>
            <div class="col-md-6">
                ${analysis.critical_paths.length > 0 ? `
                <h6><i class="bi bi-diagram-3 text-info"></i> å…³é”®è·¯å¾„</h6>
                <ul class="list-unstyled">
                    ${analysis.critical_paths.slice(0, 3).map(path => `<li><span class="badge bg-info me-1">ğŸ›¤ï¸</span>${path}</li>`).join('')}
                </ul>
                ` : ''}
                
                ${recommendations.length > 0 ? `
                <h6><i class="bi bi-lightbulb text-success"></i> AIå»ºè®®</h6>
                <ul class="list-unstyled">
                    ${recommendations.slice(0, 2).map(rec => `<li><span class="badge bg-success me-1">ğŸ’¡</span>${rec}</li>`).join('')}
                </ul>
                ` : ''}
            </div>
        </div>
    `;
    
    preview.innerHTML = html;
}

function getComplexityColor(score) {
    if (score > 0.7) return 'danger';
    if (score > 0.4) return 'warning';
    return 'success';
}

// JSONæ ¼å¼éªŒè¯
document.getElementById('custom_headers').addEventListener('blur', function() {
    const value = this.value.trim();
    if (value && value !== '') {
        try {
            JSON.parse(value);
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
        } catch (e) {
            this.classList.remove('is-valid');
            this.classList.add('is-invalid');
        }
    } else {
        this.classList.remove('is-invalid', 'is-valid');
    }
});
</script>

<style>
.ai-level-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid #dee2e6;
}

.ai-level-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.ai-level-card.border-primary {
    border-color: #0d6efd !important;
}

.ai-level-card input[type="radio"] {
    display: none;
}
</style>
{% endblock %}
